# msm
## 多标量乘法（MSM）优化
1. Pippenger 算法
    * 原理：将标量分解为固定窗口的块（如 8 位），通过分组累加减少点乘（PMULT）次数。
        * 标量分解：标量$k_i$分解为块$b_i[j]$，按块值将点分组到不同桶（Bucket）中。
        * 分组累加：对每个桶内的点进行累加（PADD），最终通过权重合并结果。
    * 优势：
        * 将 O(n⋅PMULT)复杂度降至O(桶数⋅PADD)，减少计算量。
        * 利用标量稀疏性（如 0 和 1）进一步降低计算负载。
2. 动态工作调度机制
    * 共享加法模块：所有桶共享一个流水线加法器，避免资源浪费。
    * FIFO 缓冲：使用多个 FIFO 队列暂存待处理的点，动态分配任务。
    * 并行处理单元（PE）：每个 PE 独立处理不同块的标量，支持并行计算。
    * 负载均衡：
        * 每个 PE 处理固定位数的块（如 4 位），并行处理多组块。
        * 标量稀疏性通过分组缓解，确保各 PE 负载均衡。
    * 流水线加法器设计
        * 74 级流水线：支持高效的模运算（如蒙哥马利乘法），每周期处理两个点的加法。
        * 并行处理流程：每个 PE 独立处理一组块，结果通过 FIFO 传递至共享加法模块。
3. 硬件架构优化
    * 带宽高效 NTT 模块
        * 流水线设计：通过 FIFO 实现步长访问，减少多路选择器的资源开销。
        * 可重构性：支持不同尺寸的 NTT 内核，适应动态需求。
    * 片上内存管理
        * 全局缓冲区：暂存标量和点数据，减少片外访问次数。
        * 数据对齐：按块读取数据，提升内存访问效率。
    * 并行处理单元（PE）
        * 独立处理：每个 PE 处理不同块的标量，支持并行计算。
        * 资源共享：共享加法器和 FIFO，降低硬件成本。
4. 其他优化策略
    * 特殊值处理：
        * 标量为 0 或 1 时，直接跳过 PMULT，减少无效计算。
    * 多项式与 MSM 的协同优化：
        * 标量$H_n$经 NTT 后具有均匀分布，降低最坏情况概率。
    * 异构计算：
        * MSM 的 G2 曲线部分由 CPU 处理，平衡资源利用。

## MSM（多标量乘法）技术方案与优化思路
1. 技术方案
    * 算法原理：基于 Pippenger 算法，将 253 位标量分解为多个固定窗口（12-13 位），通过分组累加减少点乘（PMULT）次数。具体步骤如下：
        * 标量分解：将标量按窗口大小分解为块。
        * 分组累加：按块值将点分组到不同桶（Bucket），桶内点累加后乘以块值并合并。
        * 权重合并：最终结果通过各块的权重2j.s合并。
    * 硬件实现：
        * FPGA 架构：在 AWS F1 实例上实现，支持 BLS12-377 G1 曲线。
        * 流水线加法器：全流水线设计，每周期处理两个点加法，延迟 238 周期。
        * 动态调度：共享加法器，通过 FIFO 缓冲和多处理单元（PE）并行处理不同窗口。
2. 优化思路
    * 减少 PMULT 次数：
        * 通过分组累加将 O(n⋅λ)次 PMULT 降至 O(桶数⋅PADD)，利用标量稀疏性（0/1 值）进一步优化。
    * 资源共享：
        * 所有桶共享一个流水线加法器，减少硬件成本。
    * 内存高效访问：
        * 点数据预处理为扭曲爱德华兹曲线的扩展坐标，减少模运算复杂度。
        * 片上 URAM 存储桶数据，支持非均匀桶大小。
    * 并行处理：
        * 多PE并行处理不同窗口，掩盖 PCIe 延迟和主机后处理时间。
    * 特殊值处理：
        * 标量为 0 或 1 时直接跳过 PMULT，减少无效计算。

| 模块 | 优化方法 | 性能 | 特点 |
| ---- | ---- | ---- | ---- |
| MSM | Pippenger 算法 + 动态调度 | 13.200 Mop/s（226 点） | 共享加法器，低资源消耗 |
| NTT | 递归分解 + 内存优化 | 224 点 NTT 延迟 0.045 秒（64 核） | 高并行性，HBM 带宽利用率提升 |

### 总结
* MSM通过算法优化和硬件共享，显著减少计算量并提升吞吐量，适用于资源受限的 FPGA 环境。
* NTT通过递归分解和内存调度，平衡了计算复杂度与硬件资源，实现高效并行处理。
* 两者均通过硬件 - 软件协同设计，在零知识证明等场景中实现了低延迟、高吞吐量的计算加速。

## 蒙哥马利算法
* 蒙哥马利算法（Montgomery Algorithm）是一种高效计算大整数模乘法的方法，广泛应用于密码学（如 RSA、ECC、同态加密等）。
* 其核心思想是将模乘法转换为无符号整数运算，避免直接计算大整数除法，从而提升计算效率。