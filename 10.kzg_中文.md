# kzg
KZG（Kate, Zaverucha, Goldberg）多项式承诺是一种经典高效的多项式承诺构造，尤其在 PLONK 协议中是基础组件，以下介绍其流程和原理：
* 流程
1. 可信设置（Trust Setup）阶段：
    * 选取公共参数，例如素数p以及与椭圆曲线关联的g。
    * 采用多方计算（MPC）仪式生成参数，过程中会确定一个随机数s，计算$g,g^s,g^{s^2},...$等，s在生成后会被丢弃，保持为秘密值 。这些参数后续用于承诺和验证过程。
2. 创建承诺和证明阶段：
    * 承诺生成：证明者拥有一个多项式，比如n次多项式P(x)。利用从可信设置得到的参数，通过特定计算得到多项式 P(x)的承诺 C（ C是椭圆曲线上的一个点 ） ，并将其发送给验证者。
    * 证明生成：验证者向证明者发送一个随机值 r。证明者计算多项式 P(x) 在 r点的评估值 P(r)，同时根据多项式余数定理等原理，计算并生成相关证明数据（涉及另一个多项式 Q(x) 在对应参数下的承诺等 ） ，一起发送给验证者 。
3. 承诺 + proof 验证阶段 ：验证者利用双线性配对（bilinear-pairing）技术，根据接收到的承诺C、评估值 P(r)以及相关证明数据，通过一系列椭圆曲线点的运算和等式验证，判断证明者提供的信息是否满足多项式的相关约束，以此验证承诺和证明的正确性 。

原理
* 基于双线性配对和椭圆曲线：KZG 多项式承诺依赖双线性配对这一密码学工具。双线性配对可以将一个乘法循环群中的两个元素对，映射到一个目标群 ，利用它可以验证乘法循环群元素间的乘法关系。椭圆曲线在有限域上生成群，群中的元素（椭圆曲线上的点）用于表示多项式相关的承诺和计算，借助椭圆曲线的性质实现安全的密码学操作 。
* Schwartz-Zippel 引理 ：该引理是 KZG 多项式承诺安全性的重要理论基础。简单来说，对于一个非零多项式 P(x)，在有限域中随机选取一个点 a，使得 P(a)=0 的概率非常低。在 KZG 承诺验证过程中，验证者通过随机挑战（选取随机数作为挑战值），利用这个特性来确保证明者很难欺骗，若证明者能通过验证，大概率说明其提供的多项式是满足要求的 。
* 多项式余数定理 ：在验证过程中发挥重要作用。当验证者给出随机值 r ，证明者根据多项式余数定理，计算 P(x)−P(r) 除以 x−r 的商多项式 Q(x) ，并将 Q(x) 相关承诺发送给验证者。验证者利用这些信息，结合双线性配对和椭圆曲线运算来验证等式是否成立，进而判断多项式承诺的有效性 。
# go-kzg-4844

1. 多项式表示与预处理
* 系数形式：将每个 Blob 数据转换为多项式的系数形式，如 $p(x)=\sum_{i = 0}^{d}p_{i}x^{i}$。
* 插值与求值：利用快速傅里叶变换（FFT）把多项式从系数形式转换为点值形式，以此加速乘法运算。
2. 多项式乘法的高效算法
* Karatsuba 算法：在 go-kzg-4844 中，多项式乘法运用 Karatsuba 分治法，将$O(n^2)$ 的时间复杂度优化至 $O(n^{1.585} )$。比如，把多项式分解为高位和低位部分，通过递归计算子问题后合并结果。
* FFT 优化：结合 FFT 可将多项式乘法复杂度进一步降至 O(nlogn)，特别适用于高次多项式。
3. 承诺生成与聚合
* 单个承诺生成：借助 BlobToCommitment 函数将每个 Blob 转换为椭圆曲线上的点$C_i=p_i(g)$。
* 聚合操作：
    * 线性组合：将多个承诺$C_i$按系数累加，生成聚合承诺$C_agg=\sum_{i=1}^{n}a_i​⋅C_i$ 。
    * 递归合并：对于大规模数据，采用 multiexp 算法批量计算多个点的标量乘法，提高聚合效率。
4. 验证与正确性证明
    * 验证逻辑：验证者通过配对操作来检查聚合承诺的正确性。例如，验证$e(C_agg,h)=e(g,\sum_{i=1}^{n}a_i​⋅p_i(a))$。
    * 递归证明支持：结合 PLONK 或 Halo2 等零知识证明协议，将聚合承诺的验证过程放在链下计算，只需在链上提交简洁证明。
### 核心函数与结构体
* kzg4844.go:
    * BlobToCommitment：将 Blob 数据转换为 KZG 承诺。
    * ComputeBlobProof：生成 Blob 的证明值。
    * VerifyBlobProof：验证 Blob 证明的有效性。
* ckgz_cgo.go:
    * ckgzBlobToCommitment：基于 CKZG 优化的承诺生成函数，使用 CGO 调用底层 C 库加速。

椭圆曲线运算优化
* BLS12 - 381 曲线：使用预编译的椭圆曲线点运算库（如 crypto/bls12381），支持快速标量乘法和配对操作。
* AVX2 指令集：在 blake2bAVX2_amd64.go 中利用 SIMD 指令集优化哈希计算，提升多项式乘法效率。

可信设置（SRS）管理
结构化引用字符串：通过多方仪式生成 SRS，确保承诺的安全性。例如，使用 MPC 生成公共参数$g,g^s,...,$，其中 s 是随机秘密值。
验证参数存储：在代码中通过 kzg4844Context 管理 SRS，避免重复计算。

